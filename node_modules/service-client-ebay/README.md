# service-client-ebay
[![Build Status](https://ebayci.qa.ebay.com/CI-Instance/buildStatus/icon?job=service-client-ebay)](https://ebayci.qa.ebay.com/CI-Instance/job/service-client-ebay)  [![Dependency Status](https://nodevalid-i3ey5.vip.lvs01.dev.ebayc3.com/nodejs/service-client-ebay.svg)](https://nodevalid-i3ey5.vip.lvs01.dev.ebayc3.com/nodejs/service-client-ebay)  [![Code Coverage](https://nodevalid-i3ey5.vip.lvs01.dev.ebayc3.com/coverage/nodejs/service-client-ebay)](http://sonar/dashboard/index?id=service-client-ebay)

This module provides an adaptor that lets you call eBay REST and COS services.

Based on the configured transport and instrumentation, you can call either RESTful experience services or COS services (which are REST-based). This service is capable of handling chunked JSON responses, required for COS services.

## Changelog

See   [CHANGELOG.MD](https://github.corp.ebay.com/nodejs/service-client-ebay/blob/master/CHANGELOG.md#changelog)

# Installation

```
npm install service-client-ebay --save
```
__Note__: make sure to register your App in [Fulcrum](https://www.fulcrum.stratus.ebay.com/cos/home) so your app has permission to get Auth Token and make service calls.

# Usage

### Server side usage based on config:
```javascript
var provider = require('service-client-ebay');

// req is http request from the request flow or mock context
var client = provider.context(req).getClient('my-client-id');
client.get({
        userId: 123121
    })
    .set('header-foo', 'header-bar')
    .set('header-A', 'header-B')
    .path('/path/to/resource')
    .end(function (err, data) {
        console.log(err, data);
    });

// or parameterized path
client.get({
        userId: 123121
    })
    .set('foo', 'bar')
    .set('A', 'B')
    .path('/path/to/:resource', { resource: 12345 })
    .end(function (err, data) {
        console.log(err, data);
    });
```

### Browser side

#### Enable service on the page
```html
<html>
    <head><lasso-head/></head>
    <body>
        Hello world!!!
        <service-use id="my-service-with-oauth" />
        <lasso-body/>
        <init-widgets/>
    </body>
</html>
```
#### Service configuration declaration
```json
{
    "services": {
        "my-service-with-oauth": {
            "protocol": "http:",
            "hostname": "api.ebay.com",
            "connectTimeout": 300, // if skipped, it would use socketTimeout value for connectTimeout
            "socketTimeout": 1500,
            "basepath": "/itm",
            "oauth": {
                "app-name": "widget-name",
                "token": ["user"],
                "scope": "http://api.ebay.com/oauth/scope/@public"
            }
        }
    }
}
```

#### Calling service
```javascript
var Provider = require('service-client-ebay') // make sure you have service-client-ebay as a dependency (browser.json)
var client = Provider.context(req).getClient('my-service-with-oauth');
client.get({
    foo: 'bar'
}).end(function handleResponse(err, res) {
    console.log('Got service response:', err || res);
});
```

Important note: The isomorphic version of this library starts at v1.x so if you have v0.x and you have errors with lasso not being able to bundle this code, upgrade to v1.x.

##### Calling a service using CORS

To this date (May 2016) the way to enable CORS support in eBay services using
raptor is using the [CORSFilter](https://wiki2/pages/viewpage.action?spaceKey=XBOX&title=COSBase+CORSFilter+Configuration)
provided by CommerceOS team. And using this library to make ajax requests to
CORS-enabled services will trigger browser errors if you don't expose certain
expected headers. These are the headers you will need to add to
`cors.exposed.headers`: X-Firefox-Spdy, Transfer-Encoding

### Debugging service calls

Sometimes one would like to know the content of request and response headers used for service calls.
You can do it by enabling 'debug' option in config bean in validate internals for the given service client.

### Instrument declaration

The service client is based on the list of instruments/handlers that are formed into a pipeline that gets executed for every request call.
The user can set their own instruments or control the list of them via the service client configuration.
If the instrument list is empty, the module will use default list of [instruments](https://github.corp.ebay.com/nodejs/service-instruments-ebay/blob/master/config/config.json#L4).

#### Instrument metadata configuration

The instrument can have the following properties:
* module - defines the node module loaded via require as instrument function
* priority - defines execution order between all instruments
* transport - if true, it defines transport metadata and priority is ignored

#### Module Instrument API

In order for the service client to successfully use instrument, it must implement the following API:

```js
module.exports = function instrument(pipe, config) {
    // init phase called for every request
    // you can use it for private state
    pipe.on('request', (request, next) => {
        // modify/examine the request 
        request.headers.Authentication = 'some token';
        // pass control to the next handler
        next();
    });
    
    // on way back, response flow, if needed
    pipe.on('response', (response, next) => {
        // modify/examine the response
        response.body = JSON.parse(response.body);
        // pass control to the next handler
        next();
    });
}
```

Parameters:
* config is a json object (optional) that provides a configuration for the instrument factory
* pipe is a reference to the pipeline for the current request.

#### Default instruments

It is configured by service-instruments-ebay/config.json/instruments-metadata section:

```json
{
    "instruments-metadata": {
        "cal": {
            "module": "instruments-ebay/lib/service-wrappers/cal",
            "priority": 10
        },
        "cache": {
            "module": "instruments-ebay/lib/service-wrappers/cache",
            "priority": 15
        }
    }
}
```

#### Declaring custom instrument

One has a few way to declare custom instruments, in-line or in services section of application config.json to share between different services

##### In-line declaration of instrument

This is done directly in instrument section of the service client config

```json
{
    "services": {
        "my-service": {
            "instruments": [
                {
                    "name": "foo",
                    "module": "path:./foo",
                    "priority": 20
                },
                {
                    "name": "bar",
                    "module": "path:./bar",
                    "priority": 30
                }
            ]
        }
    }
}
```

# Example definition and usage

The following example reads from a COS experience service that returns a chunked JSON response. The request expects to receive 'module1' and 'module2', after which the code passes the responses to the template renderer.

```javascript
var service = require('service-client-ebay');

// get client
var client = service.context(req).getClient('my-service');
// make a 'GET' reqeust to a RESTful COS service using an oauth token
client.get({
    param1: 'value1',
    param2: 'value2',
    ...
})
.set('headerA', 'valueA')
.set('multi-value-header')
    .set('foo', 'bar')
    .set('qaz', 'qwe')
    .build()
.end(function (err, resource) {
    if (err) {
        return console.error(err);
    }
    var chunk = resource.body;

    // the callback repeats as long as chunks are received
    // an 'undefined' chunk marks the end of the stream, triggering the final callback
    // if an error occurs, the connection is closed
});
```

The module provides a helper Adaptor to simplify the connection of data to the template rendering as page components are progressively rendered.

```javascript

var Adaptor = require('service-client-ebay/adaptor').Adaptor;
var adaptor = new Adaptor();

client.get().end(adaptor.getHandler());

// Adaptor provides callbacks to each module model passed to the template async renderer
var template = require('marko').load(require.resolve('path/to/template.marko'));

template.render({
    adaptor: adaptor
}, res);
```

A template example:

```html
<var name="adaptor" value="data.adaptor" />
<div>
    <await(module1 from data.adaptor.get('module1')) client-reorder="true">
        <div class="module">
            <h1>${module1.title}</h1>
        </div>
    </await>
    <await(module2 from data.adaptor.get('module2')) client-reorder="true">
        <div class="module">
            <h1>${module2.title}</h1>
        </div>
    </await>
</div>
```

## Get request
```javascript
// get client
var client = require('service-client-ebay').context(req).getClient('my-service');
client.get({
    param1: 'value1',
    param2: 'value2',
})
.end(function (err, resource) {
    if (err) {
        return console.error(err);
    }
    var chunk = resource.body;
    if (chunk)
        console.log(chunk);
    else
        console.log('end of stream');
});

```

## Post/Put requests
```javascript
// get client
var client = require('service-client-ebay').context(req).getClient('my-service');
client.post({ // put
    body: 'post request body'
    qs: {
        param1: 'value1',
        param2: 'value2',
    },
    path: 'path to target'
})
.end(function (err, resource) {
    if (err) {
        return console.error(err);
    }
    var chunk = resource.body;
    if (chunk)
        console.log(chunk);
    else
        console.log('end of stream');
});

```

## Delete request
```javascript
// get client
var client = require('service-client-ebay').context(req).getClient('my-service');
client.delete('path/to/resource')
.end(function (err, resource) {
    if (err) {
        return console.error(err);
    }
    var chunk = resource.body;
    if (chunk)
        console.log(chunk);
    else
        console.log('end of stream');
});

```
## GET request with multiple headers
This example shows an alternative way to add headers to the client.
```javascript
// get client
var client = require('service-client-ebay').context(req).getClient('my-service');
var request = client.get({
    param1: 'value1',
    param2: 'value2',
});
// add headers
request.set('Cache-Control', 'no-cache');
request.set('user-agent', 'user agent string');
// this initiates the request
request.end(function (err, resource) {
    if (err) {
        return console.error(err);
    }
    var chunk = resource.body;
    if (chunk)
        console.log(chunk);
    else
        console.log('end of stream');
});

```
## Generic requests
```javascript
// get client
var client = require('service-client-ebay').context(req).getClient('my-service');
client.request(options)
.end(function (err, resource) {
    if (err) {
        return console.error(err);
    }
    var chunk = resource.body;
    if (chunk)
        console.log(chunk);
    else
        console.log('end of stream');
});

```

## Using a cache instrument
```javascript
var provider = require('service-client-ebay');
provider.getClient('my-client').get().options({
    'cache-key': <cache key>
})
```
A service client configuration with a cache provider:
```json
"my-service": {
    "protocol": "http:",
    "hostname": "localhost",
    "transport": "generic",
    "cache": {
        "cache-provider": "path:./src/providers/my-provider"
    }
}
```
An example cache-provider API:
```javascript
module.exports.put = function put(key, value, expires, callback);
module.exports.get = function get(key, value, touch, callback);

```

## Context setup for a request to an external service

```javascript
var serviceClient = require('service-client-ebay');

serviceClient.setupContext({
    oauth: {
        'app-name': 'nodedemo1'  // provide app name for authentication if needed
    },
    tracking: false // disable tracking
},
function (err, context) {
    assert.ok(!err, err && err.stack);
    // got a context similar to req.ebay
    assert.ok(context);
    // mock marketplace ID
    context.siteInfo['marketplace-id'] = 'EBAY_DE';

    context.getClient('my-service')
        .get()
        .end(function (err, options) {
            assert.ok(!err, err && err.stack);
        });
});
```

# Transports

The service client supports following transports:
* multipart/json content is multiple chunks of valid json objects separated by '\n\n'
* sse is server-side event
* application/json is default generic restful transport
* soap

## Generic client configuration
```json
{
    "services": {
        "my-service": {
            "protocol": "http:",
            "hostname": "localhost",
            "port": 7777,
            "transport": "generic",
            "connectTimeout": 300,
            "socketTimeout": 1500,
            "basepath": "/json"
        }
    }
}
```

## SOAP client configuration
```json
"soap-resource-persistence-service": {
    "wsdl": "path:./ResourcePersistenceService.xml",
    "protocol": "http:",
    "hostname": "resreposvc.qa.ebay.com",
    "basepath": "/ResourcePersistenceService",
    "socketTimeout": 1000,
    "namespaces": true,
    "operation": "findChangeSetById",
    "method": "POST",
    "headers": {
        "X-EBAY-SOA-SECURITY-APPNAME": "ResourceRepoApp",
        "X-EBAY-SOA-SERVICE-VERSION": "1.0.0"
    },
    "instruments": ["soap", "error-handler", "retry", "config-bean", "cache", "cal"]
}
```
[More soap config examples](https://github.corp.ebay.com/nodejs/instrument-ebay/blob/master/test/soap-usecases-test.js)

To share SOAP client between operations instead of specifying operation in the config you can set operation when you make a call
```javascript
require('service-client-ebay').context(req).getClient('soap-resource-persistence-service')
    .post({
        body: {
            changeSetId: '5000680819'
        }
    })
    .options({
        operation: 'findChangeSetById'
    })
    .end(function handleResponse(err, response) {
        console.log('response: ', response.body);
    });
```

## SSE client configuration
```json
{
    "services": {
        "my-service": {
            "protocol": "http:",
            "hostname": "localhost",
            "port": 7777,
            "transport": "sse",
            "socketTimeout": 1500,
            "basepath": "/json",
            "headers": {
                "accept": "text/event-stream"
            }
        }
    }
}
```

## [SSE Sample Response](./sse-sample-response.json)

## JSON stream client configuration
```json
{
    "services": {
        "my-service": {
            "protocol": "http:",
            "hostname": "localhost",
            "port": 7777,
            "transport": "json-stream",
            "socketTimeout": 1500,
            "basepath": "/json"
        }
    }
}
```
## Other examples
Find more transport examples [here](https://github.corp.ebay.com/nodejs/instrument-ebay#service-configuration).

# Extra examples

## JSON stream
```
{
    {
            name: ‘moduleA’,
            data: { some data here }
    }// flush here
    {
            name: ‘moduleB’,
            data: { some data here }
    }
}
```

## Simple chunking

```
{
    	name: ‘moduleA’,
    	data: { some data here }
}\n\n // flush here
{
    	name: ‘moduleB’,
    	data: { some data here }
}
