# instrument-ebay 
[![Build Status](https://ebayci.qa.ebay.com/CI-Instance/buildStatus/icon?job=instrument-ebay)](https://ebayci.qa.ebay.com/CI-Instance/job/instrument-ebay) [![Dependency Status](https://nodevalid-i3ey5.vip.lvs01.dev.ebayc3.com/nodejs/instrument-ebay.svg)](https://nodevalid-i3ey5.vip.lvs01.dev.ebayc3.com/nodejs/instrument-ebay)  [![Code Coverage](https://nodevalid-i3ey5.vip.lvs01.dev.ebayc3.com/coverage/nodejs/instrument-ebay)](http://sonar/dashboard/index?id=instrument-ebay)


The module provides instrumentaation for service core transport with ebay specific instruments.

The default instruments:
* cal - wraps transport into cal transaction
* config-bean - wraps transport into config-bean based wrapper
* error-handler - wraps transport into wrapper that supports markdown & markup logic
* retry - wraps transport into wrapper that provides retry logic
* outbound-context - wraps transport into wrapper that sets request headers from req.ebay.outboundContext
* oauth - sets app or user token to request headers
* tracking - provides tracking for services
* cache - provides caching feature
* ep - provides experimentation wrapper. possible values (empty by default):
  * OPTIN_COOKIE
  * EPRESULT
* https - provides ability to invoke services using eBay Root Certificate or Self Signed Certifacte for SSL setup. 

Other tools:
* RuntimeError - allows to wrap an error passed in callback or create a new one and specify code/statusCode/type. It is also useful to capture post call stacktrace in async flow.

todo:
* add component status

## Changelog

See   [CHANGELOG.MD](https://github.corp.ebay.com/nodejs/instrument-ebay/blob/master/CHANGELOG.md#changelog)

# Installation

```
npm install instrument-ebay --save
```

# Usage

## Configuration & Instrumentation

Describing your service wrapper with instrumentation

```javascript
var instrumentEbay = require('instrument-ebay');
var objutil = require('objutil');

servicecore.register('my-service', function expservice(config, transport) {
    // instrumentation of the base transport here, only once
    transport = instrumentTool.instrument(transport);

    return {
        invoke: function invoke(params, callback) {
            transport(objutil.mixin(config, {
                clientId: 'my-service',
                qs: params,
            }, {}), callback);
        }
    };
});

module.exports.invoke = function invoke(params, callback) {
    modConfig(module, function(err, config) {
        if (err) {
            return callback(err);
        }
        var service = servicecore.create('my-service', config.get('services:my-service'));
        service.invoke(params, function (err, res) {
            callback(err, res && res.body);
        });
    });
};
```

Using cache feature with service-client-ebay module

```javascript
var provider = require('service-client-ebay');
provider.getClient('my-client').get().options({
    'cache-key': <cache key>
})
```
service client configuration with cache provider:
```json
"my-service": {
    "protocol": "http:",
    "hostname": "localhost",
    "transport": "generic",
    "cache": {
        "cache-provider": "path:./src/providers/my-provider"
    }
}
```

## Service configuration

```json
"my-service": {
    "protocol": "http:",
    "hostname": "localhost",
    "port": 7777,
    "socketTimeout": 1000,
    "transport": "generic",
    "markdown-threshold": 10,
    "instruments": ["my-wrap", "my-another-wrap", "cal"]
}
```

### Example of service using eBay Root Certificate for SSL, with https instrument  
```json
"my-service": {
    "protocol": "https:",
    "hostname": "localhost",
    "port": 7777,
    "socketTimeout": 1000,
    "transport": "generic",
    "markdown-threshold": 10,
    "https": "eBayRootCert"
}
```

### Example of service with oauth user token
```json
"my-service": {
    "protocol": "http:",
    "hostname": "localhost",
    "port": 7777,
    "socketTimeout": 1000,
    "transport": "generic",
    "markdown-threshold": 10,
    "oauth": {
        "token": ["user"]
    }
}
```

### Example of service with oauth app token
```json
"my-service": {
    "protocol": "http:",
    "hostname": "localhost",
    "port": 7777,
    "socketTimeout": 1000,
    "transport": "generic",
    "markdown-threshold": 10,
    "oauth": {
        "token": ["app"]
    }
}
```

### Example of service with oauth token with fallback from user token to recognized user token to app token
```json
"my-service": {
    "protocol": "http:",
    "hostname": "localhost",
    "port": 7777,
    "socketTimeout": 1000,
    "transport": "generic",
    "markdown-threshold": 10,
    "oauth": {
        "token": ["user", "recognized-user", "app"]
    }
}
```

### Example of service with oauth token with specific app name and scope
```json
"my-service": {
    "protocol": "http:",
    "hostname": "localhost",
    "port": 7777,
    "socketTimeout": 1000,
    "transport": "generic",
    "markdown-threshold": 10,
    "oauth": {
        "app-name": "nodedemo1",
        "scope": "http://api.ebay.com/oauth/scope/@public",
        "token": ["user"]
    }
}
```

### Example of service with oauth token with multiple specific scopes
```json
"my-service": {
    "protocol": "http:",
    "hostname": "localhost",
    "port": 7777,
    "socketTimeout": 1000,
    "transport": "generic",
    "markdown-threshold": 10,
    "oauth": {
        "scope": [
            "http://api.ebay.com/oauth/scope/@public",
            "http://api.ebay.com/oauth/scope/sell@application"
        ],
        "token": ["app"]
    }
}
```

### Example of service with oauth token and scopes specific to each type of token
```json
"my-service": {
    "protocol": "http:",
    "hostname": "localhost",
    "port": 7777,
    "socketTimeout": 1000,
    "transport": "generic",
    "markdown-threshold": 10,
    "oauth": {
        "app-name": "nodedemo1",
        "scope": {
            "user": "http://api.ebay.com/oauth/scope/@public",
            "app": "http://api.ebay.com/oauth/scope/app@public"
        },
        "token": ["user", "app"]
    }
}
```

### Example of service with cookies included into the service request from app request
```json
"my-service": {
    "protocol": "http:",
    "hostname": "localhost",
    "port": 7777,
    "socketTimeout": 1000,
    "transport": "generic",
    "markdown-threshold": 10,
    "cookies": {
        "request": true
    }
}
```

### Example of service with cookies set from the service response into app response
```json
"my-service": {
    "protocol": "http:",
    "hostname": "localhost",
    "port": 7777,
    "socketTimeout": 1000,
    "transport": "generic",
    "markdown-threshold": 10,
    "cookies": {
        "response": true
    }
}
```
### Example of service with cookies included into service request from app request and set from service response into app response
```json
"my-service": {
    "protocol": "http:",
    "hostname": "localhost",
    "port": 7777,
    "socketTimeout": 1000,
    "transport": "generic",
    "markdown-threshold": 10,
    "cookies": {
        "request": true,
        "response": true
    }
}
```
### Example demonstrating the use of markdown-threshold, retry, and markup-timeout attributes

`markdown-threshold` specifies the number of sequential timeouts before the service is automatically marked down (fail fast), the default value is 10.  
`markup-timeout` is the time to wait before attempt to mark the service up in case a service request is successful, default value is 5000ms  
`retry` is number of attempts to re-try a service call in case of a timeout, default value is 1

```json
"deals-experience-service": {
    "dnslookup": false,
	   "protocol": "http:",
	   "hostname": "rppces.qa.ebay.com",
	   "basepath": "/deals",
	   "socketTimeout": 900,
	   "transport": "generic",
	   "markdown-threshold": 10,
	   "markup-timeout": 5000,
	   "retry": 1,
	   "oauth": {
	        "token": ["user", "app"],
	             "scope": "https://api.ebay.com/oauth/scope/buy@application"
	        },
	        "headers": {
	             "content-type": "application/json",
	             "accept": "application/json"
	    }
}
```
## Error wrapping

```javascript
function readData(url, callback) {
    if (!url) {
        throw new RuntimeError({
            message: 'URL must be present'
            type: 'user'
        });
    }
    request(url, function (err, response) {
        if (err) {
            return callback(new RuntimeError({
                message: 'Failed to get data'
                error: err, // keeps stack trace
                code: 1,  // 1 by default
                type: 'system'  // system by default
            }))
        }
        if (response.statusCode >= 400) {
            return callback(new RuntimeError({
                message: 'Failed to get data'
                error: err, // keeps stack trace
                code: 2,  // 1 by default
                statusCode: response.statusCode,
                type: 'http'
            }))
        }
        callback(null, response);
    });
}
```
