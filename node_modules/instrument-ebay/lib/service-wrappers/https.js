'use strict';

var fs = require('fs'),
    https = require('https');

var asyncwrap = require('instrument-inc/wrappers').asyncwrap,
    logger = require('logging-inc').logger('instrument-inc/service-wrappers/https');

var ebayRootCerts = require('./ebay-root-certs');

module.exports = function _https(transport) {
    return asyncwrap(transport, function before(options, next) {
        var isEnabled = false;
        var agentOptions = {};

        // If HTTPS agent is already set.
        if (options.agent) {
            return next(null, options);
        }

        if (typeof options.https === 'boolean') {
            isEnabled = options.https;
        } else if (options.https === 'eBayRootCert') {
            isEnabled = true;
            agentOptions.ca = ebayRootCerts;
        } else if (options.https) {
            isEnabled = true;
            agentOptions = options.https;
        }

        if (!isEnabled) {
            return next(null, options);
        }

        options.agent = new https.Agent(agentOptions);
        next(null, options);
    });
};
