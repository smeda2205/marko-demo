'use strict';

var debug = require('debug');
var utils = require('./utils/index');
var testAapp = require('./utils/index').testAppEvents();
var punch = require('httpunch');
var svr;
var request = require('supertest');

var streams = require('../index');
var chunked = streams.ChunkedStream;
var eventStream = streams.EventStream;

var assert = require('assert');

describe(__filename, function() {

    beforeEach(function(done) {
        utils.cleanup(done);
    });

    before(function(done) {
        svr = testAapp.listen(8888, done);
    });

    after(function() {
        svr.close();
    });

    it('Should pass this test', function(done) {
        debug('booting %s', __filename);
        this.timeout(10000);
        var stream = new chunked();

        var options = {
            url: 'http://localhost:8888?delay=1000',
            socketTimeout: 1
        };

        var req = punch.get(options, function(err) {
            assert.ok(err);
            assert.equal('ECONNRESET', err.code);
            done();
        });
        var eventParts = new eventStream();
        var parts = [];
        stream.pipe(eventParts);
        req.pipe(stream);

        eventParts.on('data', function(part) {
            parts.push(part.toJson());
        });

        eventParts.on('object', function(part) {
            parts.push(part);
        });

        eventParts.once('finish', function() {
            assert.equal(7, parts.length);
            done();
        });
    });

    it('Check if Chunk has Error', function(done) {
        debug('booting %s', __filename);
        this.timeout(10000);
        var stream = new chunked();

        var options = {
            url: 'http://localhost:8888?error=true'
        };

        var req = punch.get(options);
        var eventParts = new eventStream();
        var parts = [];
        stream.pipe(eventParts);
        req.pipe(stream);

        eventParts.on('data', function(part) {
            assert.ok(part);
            if (part.name === 'error') {
                assert.equal(part.hasError, true);
            }
            parts.push(part.toJson());
        });

        eventParts.once('finish', function() {
            done();
        });
    });



});