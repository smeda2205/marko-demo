# service-instruments-ebay
[![Build Status](https://ebayci.qa.ebay.com/CI-Instance/buildStatus/icon?job=service-instruments-ebay)](https://ebayci.qa.ebay.com/CI-Instance/job/service-instruments-ebay) [![Dependency Status](https://nodevalid-i3ey5.vip.lvs01.dev.ebayc3.com/nodejs/service-instruments-ebay.svg)](https://nodevalid-i3ey5.vip.lvs01.dev.ebayc3.com/nodejs/service-instruments-ebay)  [![Code Coverage](https://nodevalid-i3ey5.vip.lvs01.dev.ebayc3.com/coverage/nodejs/service-instruments-ebay)](http://sonar/dashboard/index?id=service-instruments-ebay)


The module provides instrumentation for service-client-ebay module with ebay specific instruments.

The architecture is based on [trooba framework](https://github.com/trooba)

The default instruments:
* cal - provides cal transaction
* cache - provides caching feature
* circuit - provides Hystrix circuit, config bean, error handling
    * fallback is optional function that will be used as a fallback; example:
    ```js
        require('service-client-ebay')
        .context({})
        .getClient('some-client')
        .get({foo:'bar'})
        .fallback((err, request) => {
            // do fallback here and return promise
            return Promise.resolve({
                body: 'fallback'
            })
        })
        .end((err, response) => {});
    ```
    * configuration of circuit breaker (_NODE_ legacy values markdown-threshold/auto-markup-timeout will no longer work:
    ```
    {
        "my-service": {
            "circuit": {
                "circuitBreakerErrorThresholdPercentage": 50, // default
                "circuitBreakerRequestVolumeThreshold": 20, // default
                "circuitBreakerSleepWindowInMilliseconds": 5000, // default
                "requestVolumeRejectionThreshold": 0 // default
            }
        }
    }
    ```
      * For more details parameters, please check [hystrix circuit breaker wiki](https://github.com/Netflix/Hystrix/wiki/Configuration#CommandCircuitBreaker)
      * On configuring hystrix alerts in sherlock please use this [reference](https://docs.google.com/document/d/15uQtvrxjdLpTrCL66JJI-N0a9dx8ajBrSD8dg6_SW9o/edit#)
* config - bootstraps handlers from module-config-inc
* ep - provides experimentation for services
* retry - provides retry logic
* outbound-context - provides handler that sets request headers from req.ebay.outboundContext
* oauth - sets app or user token to request headers
* tracking - provides tracking for services
* ep - provides experimentation instrument. possible values (empty by default):
  * OPTIN_COOKIE
  * EPRESULT
* https - provides ability to invoke services using eBay Root Certificate or Self Signed Certifacte for SSL setup.
* compress - provides gzip for response.
* noop - no operation handler used to skip specific steps without changing application configurations.

The default transports:
* http - provide http/s transport
* grpc - provides grpc transport, TODO: extend from trooba-grpc-transport
* sse - provides sse transport
* xhr - provides xhr transport
* sifr - provide sifr transport, client side transports that uses sifr protocol to communicate to api.ebay.com.

Other tools:
* RuntimeError - allows to wrap an error passed in callback or create a new one and specify code/statusCode/type. It is also useful to capture post call stacktrace in async flow.

todo:
* add component status

## Changelog

See   [CHANGELOG.MD](https://github.corp.ebay.com/nodejs/service-instruments-ebay/blob/master/CHANGELOG.md#changelog)

# Installation

```
npm install service-instruments-ebay --save
```

# Usage

## Configuration

Using cache feature with service-client-ebay module

```javascript
var provider = require('service-client-ebay'); // version 2.x
provider.getClient('my-client')
.get()
.options({
    'cache-key': <cache key>
})
```
service client configuration with cache provider:
```json
"my-service": {
    "protocol": "http:",
    "hostname": "localhost",
    "cache": {
        "cache-provider": "path:./src/providers/my-provider"
    }
}
```

## Service configuration

```json
"my-service": {
    "protocol": "http:",
    "hostname": "localhost",
    "port": 7777,
    "socketTimeout": 1000,
    "transport": "generic",
    "instruments": ["my-instrument", "my-another-instrument", "cal", "circuit"],
    "circuit": {
        "circuitBreakerErrorThresholdPercentage": 50,
        "circuitBreakerRequestVolumeThreshold": 20
    }
}
```

### Example of service using eBay Root Certificate for SSL, with https instrument  
```json
"my-service": {
    "protocol": "https:",
    "hostname": "localhost",
    "port": 7777,
    "socketTimeout": 1000,
    "transport": "generic",
    "https": "eBayRootCert"
}
```

### Example of service with oauth user token
```json
"my-service": {
    "protocol": "http:",
    "hostname": "localhost",
    "port": 7777,
    "socketTimeout": 1000,
    "transport": "generic",
    "oauth": {
        "token": ["user"]
    }
}
```

### Example of service with oauth app token
```json
"my-service": {
    "protocol": "http:",
    "hostname": "localhost",
    "port": 7777,
    "socketTimeout": 1000,
    "transport": "generic",
    "oauth": {
        "token": ["app"]
    }
}
```

### Example of service with oauth token with fallback from user token to recognized user token to app token
```json
"my-service": {
    "protocol": "http:",
    "hostname": "localhost",
    "port": 7777,
    "socketTimeout": 1000,
    "transport": "generic",
    "oauth": {
        "token": ["user", "recognized-user", "app"]
    }
}
```

### Example of service with oauth token with default app name and specific scope
```json
"my-service": {
    "protocol": "http:",
    "hostname": "localhost",
    "port": 7777,
    "socketTimeout": 1000,
    "transport": "generic",
    "oauth": {
        "scope": "http://api.ebay.com/oauth/scope/@public",
        "token": ["user"]
    }
}
```

### Example of service with oauth token with specific app name and scope
```json
"my-service": {
    "protocol": "http:",
    "hostname": "localhost",
    "port": 7777,
    "socketTimeout": 1000,
    "transport": "generic",
    "oauth": {
        "app-name": "nodedemo1",
        "scope": "http://api.ebay.com/oauth/scope/@public",
        "token": ["user"]
    }
}
```

### Example of service with oauth token with multiple specific scopes
```json
"my-service": {
    "protocol": "http:",
    "hostname": "localhost",
    "port": 7777,
    "socketTimeout": 1000,
    "transport": "generic",
    "oauth": {
        "scope": [
            "http://api.ebay.com/oauth/scope/@public",
            "http://api.ebay.com/oauth/scope/sell@application"
        ],
        "token": ["app"]
    }
}
```

### Example of service with oauth token and scopes specific to each type of token
```json
"my-service": {
    "protocol": "http:",
    "hostname": "localhost",
    "port": 7777,
    "socketTimeout": 1000,
    "transport": "generic",
    "oauth": {
        "app-name": "nodedemo1",
        "scope": {
            "user": "http://api.ebay.com/oauth/scope/@public",
            "app": "http://api.ebay.com/oauth/scope/app@public"
        },
        "token": ["user", "app"]
    }
}
```

### Example of service with cookies included into the service request from app request
```json
"my-service": {
    "protocol": "http:",
    "hostname": "localhost",
    "port": 7777,
    "socketTimeout": 1000,
    "transport": "generic",
    "cookies": {
        "request": true
    }
}
```

### Example of service with cookies set from the service response into app response
```json
"my-service": {
    "protocol": "http:",
    "hostname": "localhost",
    "port": 7777,
    "socketTimeout": 1000,
    "transport": "generic",
    "cookies": {
        "response": true
    }
}
```
Example of service with cookies included into service request from app request and set from service response into app response
```json
"my-service": {
    "protocol": "http:",
    "hostname": "localhost",
    "port": 7777,
    "socketTimeout": 1000,
    "transport": "generic",
    "cookies": {
        "request": true,
        "response": true
    }
}
```

## Error wrapping

```javascript
function readData(url, callback) {
    if (!url) {
        throw new RuntimeError({
            message: 'URL must be present'
            type: 'user'
        });
    }
    request(url, function (err, response) {
        if (err) {
            return callback(new RuntimeError({
                message: 'Failed to get data'
                error: err, // keeps stack trace
                code: 1,  // 1 by default
                type: 'system'  // system by default
            }))
        }
        if (response.statusCode >= 400) {
            return callback(new RuntimeError({
                message: 'Failed to get data'
                error: err, // keeps stack trace
                code: 2,  // 1 by default
                statusCode: response.statusCode,
                type: 'http'
            }))
        }
        callback(null, response);
    });
}
```
