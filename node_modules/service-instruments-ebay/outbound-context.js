'use strict';

var Objutil = require('objutil');
var logger = require('logging-inc').logger('service-instruments-ebay/outboundContext');

module.exports = function outboundContext(pipe) {
    var req = pipe.context.app ? pipe.context.app.request : undefined;
    var ebay = req && req.ebay;

    pipe.on('request', function onRequest(request, next) {
        logger.info('outboundContext handler', pipe.context.clientId);
        var options = request;

        if (req) {
            options.headers = options.headers || {};

            // add commerce OS headers
            if (ebay) {
                var ctx = ebay.outboundContext;
                if (ctx) {
                    options.headers = Objutil.mixin(ctx, options.headers, {});
                }
                var rlogid = ebay.getRlogId && ebay.getRlogId();
                if (rlogid) {
                    options.headers.rlogid = rlogid;
                }
            }

        }

        next();
    });

};
