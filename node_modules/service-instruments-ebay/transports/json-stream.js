'use strict';

var cal = require('cal');

var Httpunch = require('httpunch'),
    JStream = require('jstream'),
    Hoek = require('hoek'),
    httpfy = require('./http-api'),
    Utils = require('../lib/utils');

var Objutil = require('objutil');
var StreamUtils = require('./stream-utils');

/**
 * Generic transport is just a passthrough to httpunch (regular http request) with JSON parsing for JSON content-type.
 * @type {exports}
 */
module.exports = function JsonStreamTransport(pipe, config) {
    pipe.on('request', function onRequest(request) {
        var st = Date.now();
        var req;
        var responseStream;

        var onceError = Hoek.once(function onErr(err) {
            pipe.throw(err);
        });

        var jsonStream = new JStream();
        jsonStream.on('data', function (model) {
            // record time taken for obtaining specific module
            cal.createTransaction('Model', model.name, function(
                err, event) {
                event.timestamp = st;
                event.complete();
            });

            responseStream.write(model);
        })
        .on('error', function (err) {
            var statusCode = req.res && req.res.statusCode;
            statusCode = statusCode >= 400 ? statusCode : undefined;
            err.statusCode = statusCode || 'ParseError';
            onceError(err);
        })
        .once('end', function () {
            responseStream.end();
        });

        config && Objutil.merge(config, request);
        req = StreamUtils.startStream(request);
        req.on('error', onceError);
        req.once('response', function onResponse(response) {
            if (response.statusCode >= 300) {
                /** Handle this for redirection and error cases separately..
                    All can have valid data
                ***/
                response.once('finish', function onFinish() {
                    pipe.respond(req.res);
                });
                return;
            }
            responseStream = pipe.streamResponse(response);
            response.pipe(jsonStream);
        });

        req.end();
    });

    httpfy(pipe);
};
