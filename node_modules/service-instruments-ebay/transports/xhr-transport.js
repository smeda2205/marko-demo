/*jslint browser: true*/
'use strict';

/**===================================================
NOTE: This module is only to handle limitation in IE9.
Once eBay drops support for IE9, we should remove
this module.
=====================================================*/

var httpfy = require('trooba-http-api');
var xhrTransport = require('trooba-xhr-transport');
var XhrUtils = xhrTransport.Utils;

var httpfy = require('./http-api');
var Legacy = require('../lib/legacy');

module.exports = function xhr(pipe, config) {
    pipe.on('request', function onRequest(request) {
        request = XhrUtils.mixin(config,
            request, {});

        Legacy.updateRequest(request);

        xhrTransport.invoke(request, function onResponse(err, response) {
            if (err) {
                return pipe.throw(err);
            }
            if (response) {
                XhrUtils.deserializeResponseHeaders(response);
            }
            pipe.respond(response);
        });
    });

    httpfy(pipe);
};

module.exports.Utils = require('trooba-xhr-transport').Utils;
