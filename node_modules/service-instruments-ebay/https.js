'use strict';

var fs = require('fs'),
    https = require('https');

var logger = require('logging-inc').logger('service-instruments-ebay/https');

var ebayRootCerts = require('./ebay-root-certs');

module.exports = function httpsHandler(pipe) {
    pipe.on('request', function onRequest(request, next) {
        logger.info('https handler', pipe.context.clientId);
        var options = request;
        var isEnabled = false;
        var agentOptions = {};

        // If HTTPS agent is already set.
        if (options.agent) {
            return next();
        }

        if (typeof options.https === 'boolean') {
            isEnabled = options.https;
        } else if (options.https === 'eBayRootCert') {
            isEnabled = true;
            agentOptions.ca = ebayRootCerts;
        } else if (options.https) {
            isEnabled = true;
            agentOptions = options.https;
        }

        if (isEnabled) {
            options.agent = new https.Agent(agentOptions);
        }

        next();
    });
};
