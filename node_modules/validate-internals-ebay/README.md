#validate-internals-ebay 
[![Build Status](https://ebayci.qa.ebay.com/CI-Instance/buildStatus/icon?job=validate-internals-ebay)](https://ebayci.qa.ebay.com/CI-Instance/job/validate-internals-ebay)    [![security](https://nodevalid-i3ey5.vip.lvs01.dev.ebayc3.com/nodejs/validate-internals-ebay.svg)](https://nodevalid-i3ey5.vip.lvs01.dev.ebayc3.com/nodejs/validate-internals-ebay/)
[![Code Coverage](https://nodevalid-i3ey5.vip.lvs01.dev.ebayc3.com/coverage/nodejs/validate-internals-ebay)](http://sonar/dashboard/index?id=validate-internals-ebay)



ValidateInternals functionality is provided automatically for your application by the infrastructure middleware setup. The main access URL for ValidateInternals is of the form:

http://host:8080/admin/v3console/ValidateInternals

The navigation bar at the top of the page provides:
* Configuration
* Component Status
* Service Client Status
* Access to Logs (CAL and application) via drop-down at far right of nav bar
* Details on what routes, middleware and package versions your application is using (meta)

## Changelog

See   [CHANGELOG.MD](https://github.corp.ebay.com/nodejs/validate-internals-ebay/blob/master/CHANGELOG.md#changelog)

# Installation
This module operates as middleware and will normally be automatically included
in the auto-supplied middleware stack supplied from the meddleware configuration. If you need to install it manually, do:

```
npm install validate-internals-ebay --save
```

# Usage

## Configuration
This screen displays the config beans that have been defined. Clicking any bean in the right hand side displays the bean configuration and provides a place to change it if you have permission to do so.
A key bean is ebay.kernel.ecv, in particular: http://localhost:8080/admin/v3console/ViewConfigCategoryXml?id=ebay.kernel.ServeTraffic

This bean is queried by the Load Balancers to determine if the application is in traffic or not.  If you want to take this specific host out of traffic, you can edit the  `Configurable Properties` at the bottom of the screen. Click on the `Value` column, `TrafficEnabled`, enter `TrafficDisabled` and click the `Submit` button at the bottom right.
Config bean values can also be changed by URL of the form:

```
http://host:8080/admin/v3console/UpdateConfigCategoryXml?id=beanname&property=value
```

The command to take a pool out of traffic would look like:

```
http://host:8080/admin/v3console/UpdateConfigCategoryXml?id=ebay.kernel.ServeTraffic&Value=TrafficDisabled
```

If you have changed values via UpdateConfigCategory and want to reset the config
bean to the default state use:

```
http://host:8080/admin/v3console/UpdateConfigCategoryXml?id=beanname&clear=true
```
## Profiling

![Profiling](https://github.corp.ebay.com/nodejs/validate-internals-ebay/blob/master/profiles.png?raw=true)

## Flame Graphs (requires Node 4.x)
![FlameGraph](https://github.corp.ebay.com/nodejs/validate-internals-ebay/blob/master/FlameGraph-sample.png?raw=true)

## Memory Profiling
Download  the Memory dump on clicking "Heap Dump" on ValidateInternals page. Open the profile file in chrome profiles tab.
![MemoryProfile](https://github.corp.ebay.com/nodejs/validate-internals-ebay/blob/master/heapprofile.png?raw=true)

## Component Status List
Allows user to register app specific state information. Note that using a config bean provides more flexibility.
Pre-defined component status items are:
* Application Build Information
* Host Information
* Initialization Information
* Threads Resource Consumption (not applicable for a node application)

## Service Client Status
Reports on service clients that have registered a status. Largely used to see Markdown-related information for the services the application uses.

## meta
The http://host:8080/admin/v3console/meta command returns a JSON response showing all the information spread across several component status items plus a display of the routes your application defines, the middleware stack it is using and a list of all top-level npm modules with version information.
The JSONView plugin for Chrome provides a nice collapsible view of the data:
https://chrome.google.com/webstore/detail/jsonview/chklaanhfefbnpoihckbnefhakgolnmc

## logs
The http://host:8080/admin/v3console/logs command displays available application logs and lets you view them. This can also be reached via the Logs dropdown at the right of the top nav bar.

## XML
If you want XML output from ValidateInternals commands, add a forceXml=true
parameter to the query string. Normally this is only used by tools so the
default for humans is an HTML page.

## Config Beans
ValidateInternals provides a way to view and manipulate config beans. If you want to define config beans, see the module that supports them for how to do this: https://github.corp.ebay.com/nodejs/config-bean-ebay

# API

## component status

### register(component, handler, renderer)
This lets you register your own component status reporter. In a clustered environment,
the registration only applies to the instance in which you do the registration. This
API is primarily for internal use to register the standard eBay components expected
by tools. You should generally be using config beans as they apply across all instances
in a cluster.

### getComponents()
Returns a list of registered component ids

### getStatus(name)
Returns the result of running handler for the specfified component name.

### getRenderer(name)
Returns the renderer for the specified component name.


## heartbeat/perfmon
* For existing CAL-based perfmon monitoring purpose, we generate CAL heartbeat data to thread 0x1. We are moving to sending this data to Sherlock via the monitor-inc module but the heartbeats are retained for the benefit of some existing tools.

~~~~text
SQLLog for r1nopool:phx5qa01c-74cb
Environment: core_staging
Label: unset;***;unset
Start: 07-24-2013 22:50:38
0  H22:50:37.69  Perfmon	OS	0	cpuUsage=1.663333333333333&jvmCpuUsage=30.680000000000003&jvmMemAvail=4523582805.333333&osName=Linux&jdk=64&numProcessors=2&serverUpHrs=2.783425925925926
0  H22:50:37.69	Perfmon	GC	0	gccount=959&gcovhdx10=674
0  H22:50:37.69	Perfmon	Threads	0	appserverBusyThreads=1
0  H22:50:37.69	Perfmon	TPS	0	tps=0&transactionTime=0&javaCpuTime=0&errorCount=0&oomErrorCount=0
~~~~
