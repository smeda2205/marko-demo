<?xml version="1.0" encoding="UTF-8"?>

<xsl:stylesheet version="1.0" xmlns:xsl="http://www.w3.org/1999/XSL/Transform">

    <xsl:output method="html"/>

    <xsl:include href='PageLayout.xsl'/>
    <xsl:include href='CpuProfile.xsl'/>
    <xsl:include href='MemoryProfile.xsl'/>

    <xsl:template match="/">

        <xsl:call-template name='page-layout'>
            <xsl:with-param name='root-node' select="ProfileView"/>

            <xsl:with-param name='title-text'>
                <xsl:choose>
                    <xsl:when test='ProfileView/ProfileRequest/@type = "cpu" '>CPU profile</xsl:when>
                    <xsl:otherwise>Memory profile</xsl:otherwise>
                </xsl:choose>
            </xsl:with-param>

            <xsl:with-param name='custom-css'>
                <xsl:call-template name='custom-css'/>
            </xsl:with-param>
        </xsl:call-template>
    </xsl:template>

    <xsl:template name='page-content'>
        <xsl:choose>
            <xsl:when test='ProfileView/ProfileRequest/@type = "cpu" '>
                <xsl:apply-templates mode='cpu' select="ProfileView/ProfileRequest"/>
            </xsl:when>

            <xsl:otherwise>
                <xsl:apply-templates mode='memory' select="ProfileView/ProfileRequest"/>
            </xsl:otherwise>
        </xsl:choose>
        <xsl:apply-templates mode="history" select="ProfileView/Profiles"/>
    </xsl:template>

    <xsl:template name="displayWorkerOption">
          <xsl:param name="worker" select="0" />
          <xsl:param name="max" select="3" />
          <xsl:param name="selected" select="0" />
          <option value="{$worker}">
              <xsl:if test="$worker = $selected">
                  <xsl:attribute name="selected">selected</xsl:attribute>
              </xsl:if>
              <xsl:text>worker </xsl:text><xsl:value-of select="$worker"/>
          </option>
          <xsl:if test="$worker + 1 &lt; $max">
              <xsl:call-template name="displayWorkerOption">
                  <xsl:with-param name="worker" select="$worker + 1" />
                  <xsl:with-param name="max" select="$max" />
                  <xsl:with-param name="selected" select="$selected" />
              </xsl:call-template>
          </xsl:if>
      </xsl:template>

    <xsl:template match="Profiles" mode="history">
        <hr />
        <script>
            function removeProfile(file) {
                var form = $('#deleteForm');
                $('#deleteForm input').first()[0].value = file;
                form.submit();
            }
        </script>
        <xsl:variable name="type" select="/ProfileView/ProfileRequest/@type" />
        <form id="deleteForm" method="post" action="/admin/v3console/profile">
            <input type="hidden" name="file" value="" />
            <input type="hidden" name="type" value="{$type}" />
        </form>
        <h2>Previous dumps (total: <xsl:value-of select="count(Profile)" />):</h2>

        <div class="profiles">
            <xsl:for-each select="Profile">
                <div class="profile">
                    <div class="date"><xsl:value-of select="@date" /></div>
                    <div class="desc">
                        <xsl:choose>
                            <xsl:when test="$type = 'cpu'">
                                <a href="profile?file={@file}&amp;type={$type}"><xsl:value-of select="@file" /></a>
                            </xsl:when>
                            <xsl:when test="$type = 'memory'">
                                <a download="{@file}" href="logs?logfile={@file}"><xsl:value-of select="@file" /></a>
                            </xsl:when>
                        </xsl:choose>
                    </div>
                    <div class="size"><xsl:value-of select="@size" /> bytes</div>
                    <div><a class="btn btn-action" href="javascript: removeProfile('{@file}');">delete</a></div>
                </div>
            </xsl:for-each>
        </div>

    </xsl:template>

    <xsl:template match="ProfileView/*[name(.) != 'Profiles']" mode="history"/>

    <xsl:template name="custom-css">

        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />

        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap.min.css" />
        <link rel="stylesheet" type="text/css" href="../css/d3-flame-chart.css" />
        <style>
        /* Space out content a bit */
        body {
          padding-top: 20px;
          padding-bottom: 20px;
        }

        /* Custom page header */
        .header {
          padding-bottom: 20px;
          padding-right: 15px;
          padding-left: 15px;
          border-bottom: 1px solid #e5e5e5;
        }

        /* Make the masthead heading the same height as the navigation */
        .header h3 {
          margin-top: 0;
          margin-bottom: 0;
          line-height: 40px;
        }

        /* Customize container */
        .container-chart {
          max-width: 990px;
        }

        .profiles {
            width: 100%
        }

        .profiles .profile {
            border: 1px solid grey;
            padding: 3px;
            float: left;
        }

        #vi_page .profile div {
            padding-top: 5px;
            padding-left: 10px;
            float: left;
        }

        #vi_page .profile div.size {
            width: 160px;
            padding-right: 10px
        }

        #vi_page .warn {
            color: #a94442;
        }

        #vi_page .profile a.btn-action {
            float: left;
            color: #fff;
            background-color: #F70500;
            border-color: #D60400;
        }

        #vi_page a.btn-primary {
            color: #fff
        }

        #vi_page #progress {
            border: 0;
            height: 40px;
            width: 40px
        }

        </style>

    </xsl:template>

</xsl:stylesheet>
