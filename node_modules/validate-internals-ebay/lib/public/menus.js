(function () {
    /*global $:false*/
    'use strict';
    var hideMore = new Array(2);
    hideMore['#moreMenu'] = false;
    hideMore['#moreLogsMenu'] = false;


    function moreTopMenu() {
        var moreMenu = $('#moreMenu');
        moreMenu.css('display', 'none');
        $('#moreLogsMenu').css('display', 'none');

        //determine starting with which menu link, it needs to be moved to the more div
        var rightBound = $('#menu2').offset().left - 200;

        // fist see if thet "More" is already set and too far to left, then clean it
        var $me = $("#more");
        var rightOffset = 0;
        if ($me && $me.attr('id') == 'more') {
            rightOffset = $me.offset().left + $me.width();
            if (rightOffset < rightBound - 100) {
                $me.css('display', 'none');
                $.each($('#moreMenu li'), function(i, v) {
                    var li = $(v);
                    $me.before(li);
                });
            }
        }

        var more = false;
        $.each($('#menu1 li'), function (i, v) {
            var li = $(v);
            if (li.attr("id") === 'more') {
                return;
            }
            if (li.attr('id') === '1') {
                return; // leave a first item
            }
            rightOffset = li.offset().left; // rightOffset == 0 --> the menu item was out of screen

            if (rightOffset > 0) {
                rightOffset = li.offset().left + li.width();
            }

            if (rightOffset === 0 || rightOffset >= rightBound) {
                if (!more) {
                    more = true;

                    if ($me && $me.attr('id') === 'more') {
                        li.before($me);
                        $me.css('display', 'block');
                    } else {
                        li.before('<li class="more" id="more"><div id="moreLinkDiv"><a id="moreLnk" href="#"><div id="moreLink">More</div></a></div></li>');

                        $('#moreLinkDiv').mouseleave(function(e) {
                            hideMore['#moreMenu'] = true;
                            setTimeout(function() {
                                closeMenu('#moreMenu');
                            }, 1500);
                        });

                        $('#moreLnk').live('click', function(e) {
                            var pos = $('#moreLnk');
                            moreMenu
                                .css('display', 'block')
                                .css('left', pos.offset().left)
                                .css('top', pos.offset().top + pos.height());
                        });
                        $me = $("#more");
                    }
                }

                li.appendTo(moreMenu);
            }
        });

        // need to sort the moreMenu's items, if any
        moreMenu.children('li').sort(function (a, b) {
            var ida = $(a).attr('id');
            var idb = $(b).attr('id');
            return (ida - idb);
        }).appendTo(moreMenu);
    }

    function showLogsMenu() {
        var logsButton = $('#menu2');
        var logsDiv = $('#moreLogsMenu');
        logsDiv.css('left', logsButton.offset().left);
        logsDiv.css('top', logsButton.offset().top + logsButton.height());
        logsDiv.css('display', 'block');
    }

    function closeMenu(menuId) {
        if (hideMore[menuId] === true) {
            $(menuId).css('display', 'none');
        }
    }

    function initTopMenu() {
        if ($.browser.msie) {
            // adjusting width of the logs menu
            var w = $('#menu2 ul').children().size();
            w = w * 100;
            $("#menu2").css("width", w + "px");
            $('#moreLogsMenu').css("width", w + "px");
        }

        $('#menu2').mouseleave(function (e) {
            hideMore['#moreLogsMenu'] = true;
            setTimeout(function () {
                closeMenu('#moreLogsMenu');
            }, 1500);
        });

        $('body > div').last().after('<div id="moreMenu"/>');
        $('#moreLogsLnk').live('click', showLogsMenu);

        var logsDiv = $('#moreLogsMenu');
        logsDiv.css('min-width', $('#menu2').width() + 'px');
        logsDiv.mouseleave(function (e) {
            hideMore['#moreLogsMenu'] = true;
            setTimeout(function () {
                closeMenu('#moreLogsMenu');
            }, 1500);
        });

        logsDiv.mouseenter(function (e) {
            hideMore['#moreLogsMenu'] = false;
        });

        var moreMenu = $('#moreMenu');
        moreMenu.mouseleave(function (e) {
            hideMore['#moreMenu'] = true;
            setTimeout(function () {
                closeMenu('#moreMenu');
            }, 1500);
        });

        moreMenu.mouseenter(function (e) {
            hideMore['#moreMenu'] = false;
        });

        moreTopMenu();
        //$(window).bind('resize', function () {
        //moreTopMenu();
        //return true;
        //});
    }
})();