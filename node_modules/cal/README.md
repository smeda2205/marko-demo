#A NodeJs CAL Client 
[![Build Status](https://ebayci.qa.ebay.com/CI-Instance/buildStatus/icon?job=node-cal)](https://ebayci.qa.ebay.com/CI-Instance/job/node-cal) [![security](https://nodevalid-i3ey5.vip.lvs01.dev.ebayc3.com/nodejs/node-cal.svg)](https://nodevalid-i3ey5.vip.lvs01.dev.ebayc3.com/nodejs/node-cal/)  [![Code Coverage](https://nodevalid-i3ey5.vip.lvs01.dev.ebayc3.com/coverage/nodejs/node-cal)](http://sonar/dashboard/index?id=node-cal) 
-----------------------------

This node module implements the [CAL](https://wiki.vip.corp.ebay.com/display/CAL/CAL+Homepage) protocol to bring CAL data publishing to NodeJs applications.

## Changelog

See   [CHANGELOG.MD](https://github.corp.ebay.com/nodejs/node-cal/blob/master/CHANGELOG.md#changelog)

##Installation
[node-cal](https://github.corp.ebay.com/nodejs/brogan-ebay/blob/master/config/config.json#L75) is configured in brogan-ebay by default. 

then import it when you want to use it:

```javascript
var cal = require('cal');
```

## Middleware
CAL middleware is express style middleware, responsible for creating and managing the lifecycle of a virtual threadId.

In bare express app, add the `cal.middleware` in middleware chain as:

```
var app = require('express');
var cal = require('cal');
...

app.use(cal.middleware());
```


## Configuration

#### enableBuffering
App can update the root transaction name by enabling buffering. If enabled, CAL will buffer messages when it receives `t` and flush everything when it receives `T`.

```js
    "cal": {
        "enableBuffering": false|true
    }
```

#### enableNestedCal
App can enable nested cal transactions. If enabled, apps can use async version of cal transaction API.

```js
    "cal": {
        "enableNestedCal": false|true
    }
```


## API
The CAL module consists of a default global logger and an API to create custom loggers. Each logger can be configured with a `formatter` and a `writeStream`. By default, all loggers are pre-configured with the CAL message format and the caldaemon writeStream.

#### createEvent(type, name, [status], [data])
See Logger.createEvent()

#### createHeartbeat(type, name, [status], [data])
See Logger.createHeartbeat()

#### createTransaction(type, name, [status], [data], [parent], [callback])
See Logger.createTransaction()

#### createLogger([options])
Creates a custom logger instance which uses any provided options or inherits settings from the default logger configuration. Configurable options are `formatter` and `writeStream`.

```javascript
// No formatter is specific, so the default global formatter is used
var logger = cal.createLogger({
  writeStream: process.stdout
});
// ...
// var event = logger.createEvent(...);
```

### defaults (get/set)
Allows configuration of global default options `formatter` and `writeStream`.

```javascript
// Default logger and all new loggers will format messages as JSON
cal.defaults = {
     formatter: cal.formatter.JSON
};
```

### Status
Constants for use with the status mesasge property. Values are `SUCCESS`, `FATAL`, `ERROR`, `EXCEPTION`, and `WARNING`.

```javascript
event.status = cal.Status.SUCCESS;
```

### stream
A property that exposes the built-in stream types. Any writeable-stream can be used, however.
Built-in streams are `cal`, `console`, and `file`. See below for configuration options of the built-in streams.

```javascript
cal.setDefaultWriteStream('file', { path: '/path/to/log/file'});
```

### formatter
This property exposes built-in formatters. Any object that conforms to the formatter API can be used, however.
The built in formatters are `cal`, `JSON`, `silent`, `pretty` and `console`.

```javascript
cal.defaults.formatter = cal.formatter.JSON;
```

### Logger
A logger instance allows clients to create and log CAL messages. The API is very similar to the default CAL API.

#### createEvent(type, name, [status], [data])
Creates a CAL Event object initialzed with the provided options.

```javascript
var cal = require('cal');

var event = cal.createEvent('my type', 'my name');
event.addData('key', 'value');
event.addData({ foo: 'bar' });
event.complete();
```

#### createHeartbeat(type, name, [status], [data])
Creates a CAL Heartbeat object initialzed with the provided options.

```javascript
var cal = require('cal');

var hb = cal.createHeartbeat('my type', 'my name');
hb.addData('key', 'value');
hb.addData({ foo: 'bar' });
hb.complete();
```

#### createTransaction(type, name, [status], [data], callback)
Creates a CAL Transaction object initialzed with the provided options.

```javascript
var cal = require('cal');

cal.createTransaction('my type', 'my name', function(err, calTxn) {
    calTxn.addData('key', 'value');
    calTxn.addData({ foo: 'bar' });
    // optional calTxn.flush();
    calTxn.complete();
});
```

### options (get/set)
Change the configuration options (such as `formatter` and `writeStream`) of the current logger. It is not recommended to change these values unless you know what you are doing. For example, swapping streams while attempting writes could cause unexpected behavior.


## Message Types
### Event
Events are used merely for logging data. For performance or profiling information, Transactions are the message type of choice.
#### Properties
`type` - The message type as speficied in the CAL protocol.

`name` - The message name as speficied in the CAL protocol.

`status` - The message status as speficied in the CAL protocol.

#### Methods
`addData(key, value), addData(encodedString), addData(object)` Adds data that will be captured/logged with this event.

`complete([status])` Finalizes and commits the event.

### Heartbeat
#### Properties
`type` - The message type as speficied in the CAL protocol.

`name` - The message name as speficied in the CAL protocol.

`status` - The message status as speficied in the CAL protocol.

#### Methods
`addData(key, value), addData(encodedString), addData(object)` - Adds data that will be captured/logged with this heartbeat.

`complete([status])` - Finalizes and commits the heartbeat.


### Transaction
#### Properties
`type` - The message type as speficied in the CAL protocol.

`name` - The message name as speficied in the CAL protocol.

`status` - The message status as speficied in the CAL protocol.

`duration` - Manually sets/override the duration of this transaction.

`correlationId` - Marks this transaction with the provided correlationId.

`parent` - Creates a relationship with the provided transaction, allowing nested profile information to be captured.

#### Methods
`addData(key, value), addData(encodedString), addData(object)` - Adds data that will be captured/logged with this transaction.

`flush()` - Flushes the current data and start time of the transaction. Transactions logged without a flush event will be marked as ATOMIC, while flushes mark them with START and STOP events. The same information is captured.

`complete([status])` - Finalizes and commits the transaction.


### Formatters
A formatter is any object that defines a property named `format` which defined a function with the signature `function (args)`.
For example, the JSON formatter is simply:

```javascript
module.exports = {
    format: functon (args) {
         return JSON.stringify(args);
    }
}
```

Built-in formaters are `cal`, `console`, `silent`, `pretty`, and `JSON`.

### Write Streams
Write streams are exactly as they sound. They are the stream that the message should be written to. Any
writable stream can be provided. Built-in writeStreams include `cal`, `console`, and `file`.
