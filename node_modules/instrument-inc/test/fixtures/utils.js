'use strict';

var express = require('express');
var pathUtils = require('path');
var shell = require('shelljs');

var BEAN_DIR = pathUtils.resolve(process.cwd(), '.beans');

module.exports.testApp = function () {
    var app = express();

    app.use(function (req, res) {
        if (req.query.delay) {
            return setTimeout(function () {
                res.end();
            }, parseInt(req.query.delay));
        }
        var maxTimeout = 0;
        Object.keys(req.query).forEach(function (name) {
            var timeout = parseInt(req.query[name]) || 0;
            maxTimeout = Math.max(timeout, maxTimeout);
            setTimeout(function () {
                res.write(JSON.stringify({
                    name: name,
                    title: 'This is module: ' + name
                }) + '\n\n');
            }, timeout);
        });
        setTimeout(function () {
            res.end();
        }, maxTimeout+100);
    });

    return app;
};

function cleanDir() {
    shell.rm('-rf', BEAN_DIR + '/*.configbean');
}

module.exports.cleanup = function cleanup(cb) {
    cleanDir();
    cb && cb();
};

var errors = require('../../errors');
var m = require('module');
var originalLoader = m._load;
var inited;
function init() {
	if (inited) {
		return;
	}

	inited = true;

	m._load = function(name, meta) {

       if (name === 'instrument-inc/errors') {
		   console.log('Injecting instrument-inc/errors for require');
		   return errors;
	   }
	   return originalLoader.apply(m, arguments);
	};

}

init();
