#instrument-inc
[![Build Status](https://ebayci.qa.ebay.com/CI-Instance/buildStatus/icon?job=instrument-inc)](https://ebayci.qa.ebay.com/CI-Instance/job/instrument-inc) [![Dependency Status](https://nodevalid-i3ey5.vip.lvs01.dev.ebayc3.com/nodejs/instrument-inc.svg)](https://nodevalid-i3ey5.vip.lvs01.dev.ebayc3.com/nodejs/instrument-inc)  [![Code Coverage](https://nodevalid-i3ey5.vip.lvs01.dev.ebayc3.com/coverage/nodejs/instrument-inc)](http://sonar/dashboard/index?id=instrument-inc)


The module provides instrumentaation for service core transport.

The default instruments:
* cal - wraps transport into cal transaction
* config-bean - wraps transport into config-bean based wrapper
* error-handler - wraps transport into wrapper that supports markdown & markup logic
* retry - wraps transport into wrapper that provides retry logic

to do:
* wrapper to printout operation name, and query parameters

## Changelog

See   [CHANGELOG.MD](https://github.corp.ebay.com/nodejs/instrument-inc/blob/master/CHANGELOG.md#changelog)

# Installation

```
npm install instrument-inc --save
```

# Usage

## Registration

You can register your own wrapper in addition to default wrappers.

```javascript
var wrappers = require('instrument-inc/wrappers');
wrappers.register('my-wrap', function wrap(transport) {
    return wrappers.asyncwrap(transport, function before(options, next) {
        console.log('my-wrap.before');
        next(null, options);
    }, function after(err, result, next) {
        console.log('my-wrap.after');
        next(err, result);
    });
});
```

## Configuration & Instrumentation

### Instrumentation
```javascript
var instrumentTool = require('instrument-inc');

// add config bean or cal
var transportCustomInstrumented = instrumentTool.instrument(transport, ['config-bean', 'cal']);

// or use all default instruments
var transportFullyInstrumented = instrumentTool.instrument(transport);
```

### Describing your service wrapper with instrumentation

```javascript
var objutil = require('objutil');
var instrumentTool = require('instrument-inc');

servicecore.register('my-service', function expservice(config, transport) {
    // instrumentation of the base transport here, only once
    transport = instrumentTool.instrument(transport, config.instrument);

    return {
        invoke: function invoke(params, callback) {
            transport(objutil.merge(config, {
                clientId: 'my-service',
                qs: params,
            }), callback);
        }
    };
});

module.exports.invoke = function invoke(params, callback) {
    modConfig(module, function(err, config) {
        if (err) {
            return callback(err);
        }
        var service = servicecore.create('my-service', config.get('services:my-service'));
        service.invoke(params, function (err, res) {
            callback(err, res && res.body);
        });
    });
};
```

### Service configuration
```json
"my-service": {
    "protocol": "http:",
    "hostname": "localhost",
    "port": 7777,
    "socketTimeout": 1,
    "transport": "generic",
    "markdown-threshold": 3,
    "retry": 1
    "markup-timeout": 5000,
    "instruments": ["my-instrument", "my-another-instrument", "cal"],
    "error-handler": {
        "success-codes": [
            404
        ]
    }
}
```
Use `error-handler` for suppressing `404` and treat as success code.
