'use strict';

var ServerResponse = require('http').ServerResponse;

var getRequest = exports.getRequest = function getRequest(out, dontCheckResponse) {
    var global = out.global;
    var request = global.req;

    if (!request) {
        request = getFromRequestLocal('request');
        if (!request && !dontCheckResponse) {
            var response = getResponse(out, true);
            request = response && response.req;
        }
        global.req = request;
    }

    return request;
}

var getResponse = exports.getResponse = function getResponse(out, dontCheckRequest) {
    var global = out.global;
    var response = global.res;

    if (!response) {
        var stream = out.stream;
        if (stream && (stream.req || stream instanceof ServerResponse)) {
            response = stream;
        } else {
            response = getFromRequestLocal('response');
            if (!response && !dontCheckRequest) {
                var request = getRequest(out, true);
                response = request && request.res;
            }
        }
        global.res = response;
    }

    return response;
}

var getEbay = exports.getEbay = function getEbay(out) {
    var global = out.global;
    var ebay = global.ebay;

    if (!ebay) {
        var request = getRequest(out);
        ebay = request && request.ebay;
        global.ebay = ebay;
    }

    return ebay;
}

function getFromRequestLocal(key) {
    try {
        return require('request-local').data[key];
    } catch(e) {}
}