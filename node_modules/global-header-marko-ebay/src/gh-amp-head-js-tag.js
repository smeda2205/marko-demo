'use strict';

module.exports = function render(input, out) {
    var globalHeader = out.global.globalHeader;
    var ampForm = (globalHeader && globalHeader.options && globalHeader.options.ampForm) ? globalHeader.options.ampForm : false;
    
    if (!globalHeader) {
        throw new Error('Global header not configured. The <gh-configure> tag (Raptor Templates) or {@gh-configure/} helper (Dust) should be included near the beginning.');
    }

    var headerAsyncValue = globalHeader.header;

    if (headerAsyncValue.isResolved()) {
        if (ampForm === 'true') {
            out.write('<script async custom-element="amp-form" src="https://cdn.ampproject.org/v0/amp-form-0.1.js"></script>');
        }
        return;
    }

    var asyncOut = out.beginAsync();
    headerAsyncValue.done(function (err, header) {
        if (err) {
            return asyncOut.error(err);
        }
        if (ampForm === 'true') {
            asyncOut.write('<script async custom-element="amp-form" src="https://cdn.ampproject.org/v0/amp-form-0.1.js"></script>');
        }
        asyncOut.end();
    });
};