'use strict';

module.exports = function globalHeaderTag(input, out) {
    var globalHeader = out.global.globalHeader;

    if (!globalHeader) {
        throw new Error('Global header not configured. The <gh-configure> tag (Raptor Templates) or {@gh-configure/} helper (Dust) should be included near the beginning.');
    }

    var options = globalHeader.options;

    var headerAsyncValue = globalHeader.header;
    if (headerAsyncValue.isResolved()) {
        headerAsyncValue.data.render(options, out);
        return;
    }

    var asyncOut = out.beginAsync();
    headerAsyncValue.done(function (err, header) {
        if (err) {
            return asyncOut.error(err);
        }

        header.render(options, asyncOut);
        asyncOut.end();

        // Fixes https://github.corp.ebay.com/nodejs/global-header-ebay/issues/25
        // Marko buffers all HTML output by default. The <async-fragment>
        // tag will flush when it begins and ends. However, the GH is not flushing
        // when it begins so anything that completed before the GH completed
        // is kept buffered unless we explicitly flush.
        out.flush();
    });
};