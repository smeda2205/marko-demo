#module-config-inc
[![Build Status](https://ebayci.qa.ebay.com/CI-Instance/buildStatus/icon?job=module-config-inc)](https://ebayci.qa.ebay.com/CI-Instance/job/module-config-inc)  [![security](https://nodevalid-i3ey5.vip.lvs01.dev.ebayc3.com/nodejs/module-config-inc.svg)](https://nodevalid-i3ey5.vip.lvs01.dev.ebayc3.com/nodejs/module-config-inc/)  [![Code Coverage](https://nodevalid-i3ey5.vip.lvs01.dev.ebayc3.com/coverage/nodejs/module-config-inc)](http://sonar/dashboard/index?id=module-config-inc)


This module provides generic API to handle configuration for modules based on [confit](https://github.com/krakenjs/confit).

It loads module config as well as app config. App config has higher precedence than module config.

Module-config-inc provides encapulation from all the different config providers (e.g. config files, VI and raptor config service via configBeans) and it takes care of normalizing and merging the config data.
Modules or app can simply use `module-config-inc` for reading the configurations.

The precedence order in using the value between local, config bean and raptor config is as follows:
* local: env.json overrides config.json
* raptor config overrides local
* config bean overrides raptor config or local
```
config-bean
      raptor-config
           {env}.json
                config.json
```

**Note:** Arrays cannot be merged, the merge process will override the whole array, so one needs to repreat all parts of the array to avoid config loss.

**Note:** don't cache the response from this module in your code, this module will take care of caching the response and refreshing it whenever there is change from the provider.

## Changelog

See   [CHANGELOG.MD](https://github.corp.ebay.com/nodejs/module-config-inc/blob/master/CHANGELOG.md#changelog)

### Installation

```
npm install module-config-inc --save
```

### Config Life Cycle [ATTENTION]

Every application developer should understand the life cycle of the config to make sure their expections match what platform provides.

There are two types of configuration: local and raptor config.

Raptor config should never be a source of truth, only a way to hot deploy changes without redeploying the application.
Eventually, all changes that were put to the raptor config repo for the application should relocate to the local configuration in the next release cycle.

Here's the steps:

* Initial application release
   * All configuration should be in config.json file
   * Raptor config should be configured as described below with raptor config version matching application version in package.json.
   * App is released to production, no raptor config data should be present in raptor config.
* Hot deployment of configuration via RaptorConfig
   * Make changes via raptor configuration and rollout
   * Make the same configuration changes to application config.json file
* Next release cycle
   * Increment application version in package.json and raptor config section in config.json to repare for the next hot deployment cycle.

In case your requirements do not match the life cycle of module-config-inc, you need to use raptor-config-ebay directly to fetch the data from config repo and resolve it by yourself (we will provide example on how to do that soon).

### Config Name Guidelines

 - default config file name is `config.json`.
 - Environment specific config's will be
    - for production - `production.json` - usually not required as all the prod configs should go to config.json.
    - for pre-production - `pre-production.json`
    - for development - `development.json`
    - for stage/qa - `staging.json`
    - for sandbox - `sandbox.json`
    - for test - `test.json`

These environment's configs are controlled via `NODE_ENV` value. In Stage/Sandbox/Production, this value is set via deploy scripts. In case of no `NODE_ENV` it will load development config.


### Usage

Reading module config

```javascript
var modConfig = require('module-config-inc');

modConfig(module, function(err, config) {
    var svcsettings = config.get('services:sessionkeysvc');
    console.log(svcsettings);
});
```

Note: passing "module" as the first parameter works fine as long as you have no other package.json files except at the root
of your module. If there is a package.json file on the path from where you run module config up to the root,
you should pass the path to the module root as a string when setting up module config.

### Register custom configs manually

In case you need to create a custom module-config, you can use this API

```javascript
var modConfig = require('module-config-inc');

modConfig.registerConfig('unique-name', javaScriptObject);
```
This `javaScriptObject` must implement method `get()` that takes `'@ConfigBean'` as a parameter and returns the config object. This API will take care of creating configbean and listening to raptorconfig change events as well.

### ConfigBeans
module-config-inc will take care of creating and loading configbeans. While defining your configuration, you can make choose/enable configs to be edited via VI or remote config editor by declaring configs under `@ConfigBean` of config.json

In module's config.json

```javascript
{
    "services": {
        "servicename": {
            "protocol": "http:",
            "hostname": "some.vip.domain.com",
            "basepath": "/resource/path",
            "transport": "generic",
            "method": "GET"
        }
    },
    "@ConfigBean": {
        "moduleName": {
            "common": [
                "services:servicename:hostname",
                "services:servicename:basepath"
            ]
        }
    }
}
```

Here this module `moduleName` is declaring  only `hostname`, `basepath` from `services:servicename` as editable.


or in app's config.json

```javascript
{
    "namespace": {
        "key1": "value1",
        "key2": "value2",
        "key3": "value3",
        "key4": "value4"
    },
    "foo": {
        "bar": {
            "baz": "bazValue",
            "qux": "quxValue",
            "aaa": "aaaValue"
        }
    },
    "@ConfigBean": {
        "appName": {
            "app": [
                "namespace:key1",
                "namespace:key2",
                "foo:bar:baz",
                "foo:bar:qux"
            ]
        }
    }
}
```

Here this app `appName` is declaring only @ConfigBean.appName keys as editable.

On change of these configuration, module-config-inc will emit the `change` event as well as update the local cache, which modules can use to reload configs.

You can also create multiple config beans

```javascript
    "namespace": {
        "key1": "value1",
        "key2": "value2"
    },
    "foo": {
        "bar": {
            "baz": "bazValue",
            "qux": "quxValue",
            "aaa": "aaaValue"
        }
    },
    "@ConfigBean": {
        "appName": {
            "common": [
                "namespace:key1"
                "foo:bar:qux"
            ],
            "app": [
                "namespace:key2",
                "foo:bar:baz",
            ]
        }
    }
}
```

This will create two config beans named 'nodejs.config.appName.app' and 'nodejs.config.appName.common'.

### RaptorConfig
module-config-inc will take care of creating and loading configbeans. While defining your configuration, you can make choose/enable configs to be edited via VI or remote config editor by declaring configs under `@ConfigBean` of config.json

**In module's config.json `moduleName` should be same as the module folder otherwise config won't be created. e.g  In `ratelimiter-ebay` module, use `ratelimiter-ebay` in `@ConfigBean` & `@RaptorConfig`**

```javascript
{
    "foo": "fooValue",
    "bar": {
        "buz": "buzValue",
        "quz": "quzValue"
    },
    "services": {
        "servicename": {
            "protocol": "http:",
            "hostname": "some.vip.domain.com",
            "basepath": "/resource/path",
            "transport": "generic",
            "method": "GET"
        }
    },
    "@ConfigBean": {
        "moduleName": { //Should be same as Module name in package.json
            "app": [ 
                  "bar",
                  "services"
            ]
        }
    },
    "@RaptorConfig": {
        "moduleName": [ //Should be same as Module name in package.json
            {
                "target": "Global",
                "project": "moduleName",
                "config": "ModuleConfig",
                "version": "1.0.0"
            }
        ]
    }
}
```

Here this module `moduleName` is declaring  all the keys under `bar`, `services` are editable. And `moduleName` is also listening to RaptorConfig with given details.


or in app's config.json
**In App's config.json `appName` should be same as the AppName in package.json  otherwise config won't be created. e.g  In `ebaykrakn` app, use `ebaykrakn` in `@ConfigBean` & `@RaptorConfig`**

```javascript
{
    "namespace": {
        "key1": "value1",
        "key2": "value2",
        "key3": "value3",
        "key4": "value4"
    },
    "foo": {
        "bar": {
            "baz": "bazValue",
            "qux": "quxValue",
            "aaa": "aaaValue"
        }
    },
    "@ConfigBean": {
        "appName": { //Should be same as appname in package.json
            "all": [
                "namespace",
                "foo"
            ]
        }
    },
    "@RaptorConfig": {
        "appName": [ //Should be same as appname in package.json
            {
                "target": "Global",
                "project": "appName",
                "config": "ModuleConfig",
                "version": "1.0.0"
            },
            {
                "target": "Global",
                "project": "appName",
                "config": "AnotherModuleConfig",
                "version": "0.0.4"
            }
        ]
    }
}
```
For the above configuration raptor config can be defined as follows:
```
(key)=(value)
==============
namespace:key1=(value)
namespace:key2=(value)
namespace:key3=(value)
namespace:key4=(value)
foo:bar:baz=(value)
foo:bar:qux=(value)
foo:bar:aaa=(value)
```

Here this app `appName` is declaring  all the keys under `namespace` & `foo` are editable. And raptorConfig wil update `appName` config bean from updates from the 2 raptor configs.

On change of these configuration, module-config-inc will update the config bean and config bean inturn emit the `change` event.

#### To associate a Raptor Config to a specific bean:
Use the attribute `mapTo` to create the association. Example:-

```json
    "application_settings": {},
    "cache_settings": {},

    "@ConfigBean": {
        "edpweb": {
            "config-bean-foo": [
                "application_settings"
            ],
            "config-bean-bar": [
                "cache_settings"
            ]
        }
    },

    "@RaptorConfig": {
        "edpweb": [
            {
                "target": "Global",
                "project": "edpweb",
                "config": "ApplicationSettings",
                "version": "1.0.0",
                "keyPath": "application_settings",
                "mapTo": "config-bean-foo"
            },
            {
                "target": "Global",
                "project": "edpweb",
                "config": "CacheSettings",
                "version": "1.0.0",
                "keyPath": "cache_settings",
                "mapTo": "config-bean-bar"
            }
            ]
        }
```

### Detecting change in raptor config of config bean

The module performs internal swap of the data so you do not need to catch change event in case you use it this way
```js
const moduleConfig = require('module-config-inc');
function makeUrlCall(cb) {
      moduleConfig(module, (err, cfg) => {
          if (err) {
             return cb(err);
          }
          var url = cfg.get('targetURL');          
          httpunch.get(url, cb);
      });
}
```

If you need to act on 'change' event to clear or rebuild some cache, you can hook to change event as shown below.
Note: change event is fired for the whole config, not just a signle value. If you need to determine that a specific value changed, you need to compare it with old value.
```js
const moduleConfig = require('module-config-inc');
let _config;
let _someValue;

function readConfig(cb) {
      if (_config) {
            return cb(null, _config);
      }
      moduleConfig(module, (err, cfg) => {
          if (err) {
             logger.error(err);
             return cb(err);
          }
          _config = cfg;
          _someValue = _config.get('someValue');
          _config.on('change', () => {
              if (cfg.get('someValue') !== _someValue) {
                  console.log('value has been changed, do something with it');
              }
          })
      });
}

```
