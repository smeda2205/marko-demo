#global-header-ebay
[![Build Status](https://ebayci.qa.ebay.com/CI-Instance/buildStatus/icon?job=global-header-ebay)](https://ebayci.qa.ebay.com/CI-Instance/job/global-header-ebay)  [![security](https://nodevalid-i3ey5.vip.lvs01.dev.ebayc3.com/nodejs/global-header-ebay.svg)](https://nodevalid-i3ey5.vip.lvs01.dev.ebayc3.com/nodejs/global-header-ebay/)  [![Code Coverage](https://nodevalid-i3ey5.vip.lvs01.dev.ebayc3.com/coverage/nodejs/global-header-ebay)](http://sonar/dashboard/index?id=global-header-ebay)


Node module to enable the eBay Global Header and Footer on the Node.js stack

## Changelog

See   [CHANGELOG.MD](https://github.corp.ebay.com/nodejs/global-header-ebay/blob/master/CHANGELOG.md#changelog)

# Maintainers

* Primary: [Triny Francis Xavier](mailto:tfrancisxavier@ebay.com)
* Secondary: [Node.JS Platform Team](mailto:DL-eBay-NodeJS-Platform@ebay.com)

# Installation

```bash
npm install global-header-ebay --save
```

# Overview

This module provides a taglib and a JavaScript API for loading the globa/header and footer. Both Dust and Marko are supported. This module depends on [optimizer](https://github.com/raptorjs3/optimizer) tags/helpers
to inject the required CSS and JavaScript into the page.

## Caching
To make the module resilient to global header service failures, the module implements multiple fallback strategies (in fallback order):
 * In-memory LRU cache with backup which expires (customizable) every 30 minutes and refreshes global header while using backup entry which leaves for 60 minutes.
   * In case of service failures it moves backup version to primary cache for another 30 minutes.
   * The cache can me cleared by using lastCleanup=N+1 via config bean.
   * Can be disabled by setting 'globalheader__cache__enable' to false. In such case it would try to fallback to static headers in case they are enabled or return error.
 * Cold cache is used to store newly loaded header/footer templates to survive restarts.
   * Can be turned on/off ('on' by default) in config bean (nodejs.config.globalheader.commons) by setting 'globalheader__cache__cold__enable'
 * Static header/footer templates loaded from global-header-resources-ebay (generated periodically and published to private ebay npm repository).
   * Can be disabled using 'globalheader__fallback' = false (true by default)

# Usage

The use of global header tags or helpers may trigger EP or PDS call that may increase the time of your page rendering if you use standard MVC pattern (get model first and then start rendering.) In this case you might want to turn on preloading or global header PDS and EP data. Here's an example of routes.json that does this:
```json
{
    "path": "GET /sch/i.html",
    "handler": "require:src/pages/index",
    "pagename": "srpnweb",
    "global-header": {
        "preload": true
    }
}
```

## Dust Usage

### Example Dust Page

```html
<!-- Configure the global header and global footer: -->
{@gh-configure layout="FULL" footerLayout="MIN" /}

<!-- You must use the <optimizer-page> tag for required JavaScript
     code to be included: -->
{@optimizer-page name="my-page" package-package="./optimizer.json"/}

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Hello World</title>

    {! You must use the {@gh-head-css/} tag for required CSS
         code to be included: !}
    {@gh-head-css/}

    {@optimizer-head/}
</head>
<body>
    {! Insert the global footer !}
    {@gh-header />}

    <h1>Hello World</h1>

    {! Insert the global footer !}
    {@gh-footer /}

    {@optimizer-body /}

    {! You must use the {@gh-body-js} tag for required JavaScript
         code to be included: !}
    {@gh-body-js/}
</body>
</html>
```

### Dust Helpers

#### `@gh-configure`

This tag should be included at the top of the page and is used to configure both the global header and the global footer.

Supported attributes:

* __layout__ (string): Header layout: FULL | MIN (default: full)
* __footerLayout__ (string): Footer layout: NORMAL | MIN (default: normal)
* __var__ (string): Header variation: '' | mweb (default: '')
* __categoryId__ (string): For auto-selecting in category dropdown (0 value if not auto-selecting) and for showing the Vertical Navigation Layer (VNL) for Fashion and Motors
* __categories__ (string): Comma-separated list of L1 categories to be shown in the categories select. Format is: Restaurant &amp; Catering: 11874,”Business &amp; Industrial:12576”.
* __refinedCategories__ (string): Comma-separated list of refined categories. Used to provide L2 or lower categories to the categories dropdown. For example, "Restaurant &amp; Catering: 11874,”Business &amp; Industrial:12576”
* __searchFormFields__ (Array): An array of hidden fields to add to the search form (each item should have a `name` and `value` property)
* __searchFormAction__ (String): The URL to use as the `<form>` action when a search is submitted
* __searchKeywords__ (String): Search keyword to display in search bar
* __allCategoriesText__ (String): all categories text to be added to dropdown
* __dsVersion__ (integer): Design system version. Use this flag to include the appropriate global css (omit unless you have a specific design version you require)

Further details on these attributes is at the [global header](http://raptor.corp.ebay.com/portal/2.0.0/learn/topics/Global-Header) page.
#### `@gh-header`

Used to insert the HTML for the global header.

Supported attributes:

* (none)

#### `@gh-footer`

Used to insert the HTML for the global footer.

Supported attributes:

* (none)

#### `@gh-head-css`

Renders `<link>` tags to include the required CSS. This tag should be placed within the `<head>` element.

Supported attributes:

* (none)

#### `@gh-body-js`

Renders `<script>` tags to include the required JavaScript. This tag should be placed at the end of the `<body>` element.

Supported attributes:

* (none)


## Marko Usage

### Example Marko Page

```html
<!-- Configure the global header and global footer: -->
<gh-configure layout="FULL"/>

<!-- You must use the <optimizer-page> tag for required JavaScript
     code to be included: -->
<optimizer-page name="my-page" package-package="./optimizer.json"/>

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Hello World</title>

    <!-- You must use the <gh-head-css> tag for required CSS
         code to be included: -->
    <gh-head-css/>
    <optimizer-head/>
</head>
<body>
    <!-- Insert the global footer -->
    <gh-header/>

    <h1>Hello World</h1>

    <!-- Insert the global footer -->
    <gh-footer/>

    <optimizer-body/>

    <!-- You must use the <gh-body-js> tag for required JavaScript
         code to be included: -->
    <gh-body-js/>
</body>
</html>
```

### Marko Custom Tags

#### `<gh-configure>`

This tag should be included at the top of the page and is used to configure both the global header and the global footer.

Supported attributes:

* __layout__ (string): Header layout: FULL | MIN (default: full)
* __footerLayout__ (string): Footer layout: NORMAL | MIN (default: normal)
* __var__ (string): Header variation: '' | mweb (default: '')
* __categoryId__ (string): For auto-selecting in category dropdown (0 value if not auto-selecting) and for showing the Vertical Navigation Layer (VNL) for Fashion and Motors
* __categories__ (string): Comma-separated list of L1 categories to be shown in the categories select
* __refinedCategories__ (string): Comma-separated list of refined categories. Used to provide L2 or lower categories to the categories dropdown.
* __searchFormFields__ (Array): An array of hidden fields to add to the search form (each item should have a `name` and `value` property)
* __searchFormAction__ (String): The URL to use as the `<form>` action when a search is submitted
* __searchKeywords__ (String): Search keyword to display in search bar
* __allCategoriesText__ (String): all categories text to be added to dropdown
* __dsVersion__ (integer): Design system version. Use this flag to include the appropriate global css (omit unless you have a specific design version you require)

#### `<gh-header>`

Used to insert the HTML for the global header.

Supported attributes:

* (none)

#### `<gh-footer>`

Used to insert the HTML for the global footer.

Supported attributes:

* (none)

#### `<gh-head-css>`

Renders `<link>` tags to include the required CSS. This tag should be placed within the `<head>` element.

Supported attributes:

* (none)

#### `<gh-body-js>`

Renders `<script>` tags to include the required JavaScript. This tag should be placed at the end of the `<body>` element.

Supported attributes:

* (none)

### AMP
Global header also supports [AMP](https://www.ampproject.org/) versions of GH & GF which are fully AMP compliant. To use the AMP versions, `<gh-configure>` tag should be configured as below
```HTML
<gh-configure var="mweb" layout="MIN" footerLayout="MIN"/>
```

#### `<gh-amp-css/>`
Render the style content (NOT the `<style>` tag itself) for the mobile min version of Global Header. This should be used inside the `<style amp-custom>` tag
```HTML
<style amp-custom>
    <gh-amp-css/>
</style>
```
Supported attributes:

* (none)

#### `<gh-amp-header/>`
Used to insert the HTML for the AMP global header.

Supported attributes:

* (none)

#### `<gh-amp-footer/>`

Used to insert the HTML for the AMP global footer.

Supported attributes:

* (none)

### Marko V3 Upgrade

Install `global-header-marko-ebay` module to support Marko V3+ compatible taglib.

https://github.corp.ebay.com/nodejs/global-header-marko-ebay
