'use strict';

var utils = require('./utils'),
    scriptGrabber = utils.getPattern('script'),
    customAttributeGrabber = utils.getPattern('customAttribute');

var logger = require('logging-inc').logger('global-header-ebay/Footer');

function Footer(footerResponse) {
    this._html = footerResponse.html;
    this._htmlTemplate = footerResponse.htmlTemplate;
}

Footer.prototype = {
    render: function (options, context) {
        if (!options) {
            throw new Error('"options" argument is required');
        }
        var asyncOut = context.beginAsync();
        options.modifiedApplicationPageId = '';
        if (options.var === 'amp' && options.applicationPageId) {
            options.modifiedApplicationPageId = 'p' + options.applicationPageId + '.';
        }
        try {
            this._htmlTemplate.render(options, function(err, html, out) {
                asyncOut.write(html);
                asyncOut.end();
            });
        }
        catch (err) {
            logger.error('Failed to render the footer', err);
            asyncOut.end(err);
        }
    },
    /**
     * @deprecated.
     */
    renderAMP: function(context) {
        var html = this._html;
        if (!html) {
            return;
        }

        context.write(html
                        .replace(scriptGrabber, '') // Strip the script tags
                        .replace(customAttributeGrabber, '')); // Strip the custom _sp attribute
    }
};

module.exports = Footer;
