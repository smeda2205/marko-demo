'use strict';

var AsyncValue = require('raptor-async/AsyncValue');

function empty(str) {
    return str === null || str.length === 0 || !(/\S/).test(str);
}

function processCartValues(siteId, siteCart, soleCart) {
    if (empty(siteCart)) {
        return empty(soleCart) ? 0 : soleCart;
    }
    var carts = siteCart.split(',');
    var i = carts.length;
    while (i--) {
        var c = carts[i];
        if (!c) {
            continue;
        }
        c = c.split(':');
        if (siteId === +c[0]) {
            return +c[1];
        }
    }
    return 0;
}

module.exports.pdsProcessor = function pdsProcessor(req, callback) {

    if (!req || !req.ebay || !req.ebay.pds) {
        return callback(new Error('PDS middleware not initialized'));
    }

    var ghPdsPending = req.ebay.ghPdsPending;
    if (ghPdsPending) {
        return ghPdsPending.done(callback);
    }

    ghPdsPending = req.ebay.ghPdsPending = new AsyncValue();
    ghPdsPending.done(callback);

    var pdsAttributes;
    var siteId = req.ebay.getSiteId();
    var signedIn = req.ebay.hasLevel1UserId() || req.ebay.hasLevel2UserId() || req.ebay.getPersistentUserId();
    if (signedIn) {
        req.ebay.pds.getAttributes('COUNT_ITEMS_IN_SHOP_CART_PER_SITE_U', 'COUNT_ITEMS_IN_SHOP_CART_S',
            function (err, attributes) {
                if (err) {
                    return ghPdsPending.reject(err);
                }
                if (attributes) {
                    pdsAttributes = {
                        cart: processCartValues(siteId, attributes.COUNT_ITEMS_IN_SHOP_CART_PER_SITE_U, attributes.COUNT_ITEMS_IN_SHOP_CART_S)
                    };
                }
                ghPdsPending.resolve(pdsAttributes);
            });
    } else {
        req.ebay.pds.getAttribute('COUNT_ITEMS_IN_SHOP_CART_P', function (err, attribute) {
            if (err) {
                return ghPdsPending.reject(err);
            }
            pdsAttributes = {
                cart: attribute || 0
            };
            ghPdsPending.resolve(pdsAttributes);
        });
    }
};
